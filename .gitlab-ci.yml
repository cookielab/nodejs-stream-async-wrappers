stages:
  - prepare
  - test
  - release

image: cookielab/nodejs:8

yarn:
  stage: prepare
  tags:
    - docker
  script:
    - yarn
  cache:
    key: "$CI_JOB_NAME"
    paths:
      - node_modules
  artifacts:
    name: "$CI_JOB_NAME"
    expire_in: 1 day
    paths:
      - node_modules

lint:
  stage: test
  tags:
    - docker
  dependencies:
    - yarn
  script:
    - bin/lint

flow:
  stage: test
  tags:
    - docker
  dependencies:
    - yarn
  script:
    - bin/flow

test:
  stage: test
  tags:
    - docker
  dependencies:
    - yarn
  script:
    - bin/jest --coverage
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'

publish:
  stage: release
  tags:
    - docker
  before_script:
    - echo "$NPMRC" > ~/.npmrc
  script:
    - npm version "$CI_COMMIT_TAG" --no-git-tag-version --allow-same-version
    - npm publish --verbose
  only:
    - tags

github:
  stage: release
  tags:
    - docker
  dependencies: []
  image: cookielab/git-mirror:2.15
  before_script:
    - eval $(ssh-agent -s)
    - import-ssh-key
    - git config --global user.email "robot@cookielab.io"
    - git config --global user.name "Cookie Monster"
  script:
    - git remote rm mirror || true
    - git remote add mirror git@github.com:cookielab/nodejs-stream-async-wrappers.git
    - git checkout -B master origin/master
    - git push mirror master
    - git push mirror master --tags
  only:
    - tags
